<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FTMO â€“ D1 EMA Ã‡arÅŸaf</title>
  <style>
    html, body { height: 100%; }
    body { font-family: Arial, sans-serif; margin: 18px; }

    .top {
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:12px; flex-wrap:wrap;
    }

    /* 4 kart ekranÄ± eÅŸit doldursun: 2x2 */
    .grid {
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: 1fr;
      gap: 14px;
      margin-top: 14px;
      height: calc(100vh - 120px);
    }

    .card {
      border:2px solid #ddd;
      border-radius:14px;
      padding:12px;
      background:#fff;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      min-height: 0;
      position: relative; /* buton iÃ§in */
    }

    .green { border-color:#22c55e; box-shadow: 0 0 0 2px rgba(34,197,94,.15) inset; }
    .title { font-weight:800; font-size:16px; }
    .muted { color:#666; font-size:12px; }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; }
    .pill-long { border-color:#22c55e; }
    .pill-short { border-color:#ef4444; }

    button { padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .pager { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .active { font-weight:900; }

    .row { display:flex; justify-content:space-between; align-items:center; gap:8px; }

    /* chart alanÄ± kartÄ±n kalanÄ±nÄ± doldursun */
    .chartWrap {
      margin-top:10px;
      border:1px solid #eee;
      border-radius:12px;
      overflow:hidden;
      flex: 1;
      min-height: 0;
      background:#fff;
    }
    iframe { display:block; width:100%; height:100%; border:0; }

    /* Kart iÃ§i bÃ¼yÃ¼tme butonu */
    .expandBtn{
      position:absolute;
      top:10px;
      right:10px;
      width:34px;
      height:34px;
      border-radius:10px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      line-height:1;
      opacity:0.95;
    }
    .expandBtn:hover{ opacity:1; }

    /* Modal (popup) */
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(1200px, 98vw);
      height:min(720px, 96vh);
      background:#fff;
      border-radius:16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      border:1px solid #ddd;
    }
    .modalHeader{
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      border-bottom:1px solid #eee;
    }
    .modalTitle{ font-weight:900; }
    .modalClose{
      width:40px;
      height:36px;
      border-radius:12px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
      font-size:18px;
    }
    .modalBody{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
      min-height:0;
    }
    .modalInfo{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .modalChart{
      flex:1;
      min-height:0;
      border:1px solid #eee;
      border-radius:14px;
      overflow:hidden;
    }
    .modalChart iframe{ width:100%; height:100%; }
    .linkRow a{ color:#444; font-size:12px; }
  </style>
</head>

<body>
  <div class="top">
    <div>
      <div style="font-size:20px;font-weight:900;">FTMO â€“ D1 EMA Ã‡arÅŸaf</div>
      <div class="muted">
        4 kart = ekranÄ± tam doldurur. TradingView mum + MACD + volume kapalÄ±. Her kartta â¤¢ ile bÃ¼yÃ¼t.
      </div>
    </div>

    <div>
      <div class="pager" id="pager"></div>
      <div class="muted" id="updated"></div>
    </div>
  </div>

  <div class="grid" id="grid">YÃ¼kleniyor...</div>

  <!-- Modal -->
  <div class="modalOverlay" id="modalOverlay" onclick="overlayClick(event)">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Grafik">
      <div class="modalHeader">
        <div>
          <div class="modalTitle" id="modalTitle">â€”</div>
          <div class="muted" id="modalSub">â€”</div>
        </div>
        <button class="modalClose" onclick="closeModal()" aria-label="Kapat">âœ•</button>
      </div>

      <div class="modalBody">
        <div class="modalInfo" id="modalInfo"></div>
        <div class="modalChart" id="modalChart"></div>
        <div class="linkRow" id="modalLink"></div>
      </div>
    </div>
  </div>

<script>
  // ðŸ”— Backend URL
  let API_BASE = "https://ftmo-carsaf.onrender.com";

  // âœ… 5 sayfa x 4 enstrÃ¼man (backend ile aynÄ±)
  const PAGES = [
    ["EURUSD","USDJPY","GBPUSD","AUDUSD"],
    ["USDCAD","USDCHF","EURJPY","EURGBP"],
    ["GBPJPY","AUDJPY","XAUUSD","XAGUSD"],
    ["USOIL","US500","NAS100","US30"],
    ["GER40","UK100","JP225","AUS200"],
  ];

  let currentPage = 0;

  // TradingView sembol eÅŸlemesi
  const TV_SYMBOL = {
    "EURUSD": "FX:EURUSD",
    "USDJPY": "FX:USDJPY",
    "GBPUSD": "FX:GBPUSD",
    "AUDUSD": "FX:AUDUSD",
    "USDCAD": "FX:USDCAD",
    "USDCHF": "FX:USDCHF",
    "EURJPY": "FX:EURJPY",
    "EURGBP": "FX:EURGBP",
    "GBPJPY": "FX:GBPJPY",
    "AUDJPY": "FX:AUDJPY",

    "XAUUSD": "OANDA:XAUUSD",
    "XAGUSD": "OANDA:XAGUSD",

    "USOIL": "TVC:USOIL",
    "US500": "TVC:SPX",
    "NAS100": "TVC:NDX",
    "US30": "TVC:DJI",
    "GER40": "TVC:DEU40",
    "UK100": "TVC:UKX",
    "JP225": "TVC:NI225",
    "AUS200": "TVC:AU200"
  };

  function pill(item){
    if (item.sheet === "LONG") return `<span class="pill pill-long">Ã‡ARÅžAF LONG</span>`;
    if (item.sheet === "SHORT") return `<span class="pill pill-short">Ã‡ARÅžAF SHORT</span>`;
    return `<span class="pill">NONE</span>`;
  }

  function cardClass(item){
    if (item.sheet === "LONG") return "card green";
    if (item.sheet === "SHORT") return "card green";
    return "card";
  }

  function fmt(n){
    if (typeof n !== "number") return "-";
    return n.toFixed(2);
  }

  // TradingView embed: MACD aÃ§Ä±k, volume kapalÄ±
  function tvEmbedUrl(name){
    const sym = TV_SYMBOL[name];
    if (!sym) return null;

    const params = new URLSearchParams({
      symbol: sym,
      interval: "D",
      style: "1",
      theme: "light",
      hide_top_toolbar: "1",
      hide_side_toolbar: "1",
      allow_symbol_change: "0",
      studies: "MACD@tv-basicstudies",
      hide_volume: "1",
      withdateranges: "0",
      saveimage: "0",
      details: "0",
      hotlist: "0",
      calendar: "0",
      locale: "tr"
    });

    return `https://s.tradingview.com/widgetembed/?${params.toString()}`;
  }

  function tvChartLink(name){
    const sym = TV_SYMBOL[name];
    if (!sym) return null;
    return `https://www.tradingview.com/chart/?symbol=${encodeURIComponent(sym)}`;
  }

  function chartIframeHtml(name){
    const url = tvEmbedUrl(name);
    if (!url) return `<div class="muted">Mini chart yok</div>`;
    return `<iframe src="${url}" loading="lazy"></iframe>`;
  }

  function renderPager(){
    const pager = document.getElementById("pager");
    pager.innerHTML = "";

    for (let i = 0; i < PAGES.length; i++){
      const b = document.createElement("button");
      b.textContent = `Sayfa ${i+1}`;
      if (i === currentPage) b.classList.add("active");
      b.onclick = () => loadData(i);
      pager.appendChild(b);
    }

    const r = document.createElement("button");
    r.textContent = "Yenile";
    r.onclick = () => loadData(currentPage);
    pager.appendChild(r);
  }

  // Modal kontrol
  function openModal(item){
    const overlay = document.getElementById("modalOverlay");
    const title = document.getElementById("modalTitle");
    const sub = document.getElementById("modalSub");
    const info = document.getElementById("modalInfo");
    const chart = document.getElementById("modalChart");
    const link = document.getElementById("modalLink");

    title.textContent = item.name;
    sub.textContent = `${item.symbol} â€¢ ${item.type}`;

    info.innerHTML = item.ok ? `
      <div>
        <div><b>${pill(item)}</b></div>
        <div class="muted">Close: ${fmt(item.last_close)}</div>
        <div class="muted">EMA20: ${fmt(item.ema20)} | EMA50: ${fmt(item.ema50)}</div>
        <div class="muted">EMA100: ${fmt(item.ema100)} | EMA200: ${fmt(item.ema200)}</div>
      </div>
    ` : `
      <div style="color:#b91c1c;">Veri/Hata</div>
      <div class="muted">${item.error || item.reason || ""}</div>
    `;

    chart.innerHTML = chartIframeHtml(item.name);

    const tvLink = tvChartLink(item.name);
    link.innerHTML = tvLink ? `<a href="${tvLink}" target="_blank" rel="noreferrer">TradingViewâ€™de aÃ§</a>` : "";

    overlay.style.display = "flex";
    document.body.style.overflow = "hidden";
  }

  function closeModal(){
    const overlay = document.getElementById("modalOverlay");
    overlay.style.display = "none";
    document.getElementById("modalChart").innerHTML = "";
    document.body.style.overflow = "auto";
  }

  function overlayClick(e){
    // Sadece arka siyaha tÄ±klayÄ±nca kapansÄ±n
    if (e.target && e.target.id === "modalOverlay") closeModal();
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
  });

  async function loadData(pageIndex){
    currentPage = pageIndex;
    renderPager();

    const grid = document.getElementById("grid");
    grid.textContent = "YÃ¼kleniyor...";

    try {
      const res = await fetch(`${API_BASE}/api/watchlist/${currentPage + 1}`);
      const data = await res.json();

      document.getElementById("updated").textContent =
        `Son gÃ¼ncelleme (UTC): ${data.updated_utc} | Sayfa: ${data.page}`;

      const wanted = new Set(PAGES[currentPage]);
      const items = (data.items || []).filter(x => wanted.has(x.name));

      grid.innerHTML = "";
      for (const item of items){
        grid.insertAdjacentHTML("beforeend", `
          <div class="${cardClass(item)}">
            <button class="expandBtn" title="BÃ¼yÃ¼t" aria-label="BÃ¼yÃ¼t" data-name="${item.name}">â¤¢</button>

            <div class="row">
              <div class="title">${item.name}</div>
              ${pill(item)}
            </div>
            <div class="muted">${item.symbol} â€¢ ${item.type}</div>

            ${item.ok ? `
              <div style="margin-top:8px">
                <div>Close: <b>${fmt(item.last_close)}</b></div>
                <div class="muted">EMA20: ${fmt(item.ema20)} | EMA50: ${fmt(item.ema50)}</div>
                <div class="muted">EMA100: ${fmt(item.ema100)} | EMA200: ${fmt(item.ema200)}</div>
              </div>
            ` : `
              <div style="margin-top:8px;color:#b91c1c">Veri/Hata</div>
              <div class="muted">${item.error || item.reason || ""}</div>
            `}

            <div class="chartWrap">
              ${chartIframeHtml(item.name)}
            </div>

            <div style="margin-top:6px">
              ${tvChartLink(item.name) ? `<a class="muted" href="${tvChartLink(item.name)}" target="_blank" rel="noreferrer">TradingViewâ€™de aÃ§</a>` : ""}
            </div>
          </div>
        `);
      }

      // Butonlara tÄ±klama eventlerini baÄŸla
      // (HTML string ile bastÄ±ÄŸÄ±mÄ±z iÃ§in sonra baÄŸlamak lazÄ±m)
      const cards = Array.from(document.querySelectorAll(".card"));
      for (const card of cards){
        const btn = card.querySelector(".expandBtn");
        if (!btn) continue;
        const nm = btn.getAttribute("data-name");
        const found = items.find(x => x.name === nm);
        btn.onclick = () => openModal(found);
      }

      if (!grid.innerHTML.trim()) {
        grid.textContent = "Bu sayfada veri yok.";
      }
    } catch (e) {
      grid.innerHTML = `<div style="color:#b91c1c">Hata: ${e}</div>`;
    }
  }

  renderPager();
  loadData(0);
</script>
</body>
</html>