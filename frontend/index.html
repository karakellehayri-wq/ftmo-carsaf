<script>
  let API_BASE = "https://ftmo-carsaf.onrender.com";

  // 20 enstrümanı 3 sayfaya böldük (8 + 8 + 4)
  const PAGES = [
    ["EURUSD","USDJPY","GBPUSD","AUDUSD","USDCAD","USDCHF","EURJPY","EURGBP"],
    ["GBPJPY","AUDJPY","XAUUSD","XAGUSD","USOIL","US500","NAS100","US30"],
    ["GER40","UK100","JP225","AUS200"]
  ];

  let currentPage = 0;

  function cardClass(item){
    if (item.sheet === "LONG") return "card green";
    if (item.sheet === "SHORT") return "card green"; // istersen short için kırmızı yaparız
    return "card";
  }
  function pill(item){
    if (item.sheet === "LONG") return `<span class="pill pill-long">ÇARŞAF LONG</span>`;
    if (item.sheet === "SHORT") return `<span class="pill pill-short">ÇARŞAF SHORT</span>`;
    return `<span class="pill">NONE</span>`;
  }
  function fmt(n){
    if (typeof n !== "number") return "-";
    return n.toFixed(2);
  }

  async function loadData(pageIndex){
    currentPage = pageIndex;

    // üstte sayfa butonlarını güncelle
    document.querySelectorAll(".pageBtn").forEach((b, i) => {
      b.style.fontWeight = (i === currentPage) ? "900" : "400";
    });

    const grid = document.getElementById("grid");
    grid.textContent = "Yükleniyor...";

    // Backend’den tüm listeyi alıyoruz (tek istek) — ama backend 20 çağrı yaptığı için 429 oluyor.
    // Biz burada "rate limit" için sayfa yenilemeyi azaltacağız.
    const res = await fetch(`${API_BASE}/api/watchlist`);
    const data = await res.json();

    document.getElementById("updated").textContent = `Son güncelleme (UTC): ${data.updated_utc}`;

    // Bu sayfada göstereceğimiz isimler:
    const wanted = new Set(PAGES[currentPage]);

    grid.innerHTML = "";
    for (const item of data.items){
      if (!wanted.has(item.name)) continue;

      grid.insertAdjacentHTML("beforeend", `
        <div class="${cardClass(item)}">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div class="title">${item.name}</div>
            ${pill(item)}
          </div>
          <div class="muted">${item.symbol} • ${item.type}</div>
          <hr style="border:none;border-top:1px solid #eee;margin:10px 0;">
          ${item.ok ? `
            <div>Close: <b>${fmt(item.last_close)}</b></div>
            <div class="muted">EMA20: ${fmt(item.ema20)} | EMA50: ${fmt(item.ema50)}</div>
            <div class="muted">EMA100: ${fmt(item.ema100)} | EMA200: ${fmt(item.ema200)}</div>
          ` : `
            <div style="color:#b91c1c;">Veri/Hata</div>
            <div class="muted">${item.error || item.reason || ""}</div>
          `}
        </div>
      `);
    }
  }

  // Sayfa butonlarını HTML'e ekle
  (function initPager(){
    const top = document.querySelector(".top > div:last-child");
    const pager = document.createElement("div");
    pager.style.display = "flex";
    pager.style.gap = "8px";
    pager.style.marginTop = "8px";

    for (let i = 0; i < PAGES.length; i++){
      const btn = document.createElement("button");
      btn.className = "pageBtn";
      btn.textContent = `Sayfa ${i+1}`;
      btn.onclick = () => loadData(i);
      pager.appendChild(btn);
    }
    top.appendChild(pager);
  })();

  loadData(0);
</script>
