<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FTMO – D1 EMA Çarşaf</title>
  <style>
    html, body { height: 100%; }
    body { font-family: Arial, sans-serif; margin: 18px; }

    .top { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; }
    .pager { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    button { padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .active { font-weight:900; }

    /* 2x2 full screen */
    .grid {
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: 1fr;
      gap: 14px;
      margin-top: 14px;
      height: calc(100vh - 120px);
    }

    .card {
      border:2px solid #ddd;
      border-radius:14px;
      padding:12px;
      background:#fff;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      min-height:0;
      position:relative;
    }

    .green { border-color:#22c55e; box-shadow: 0 0 0 2px rgba(34,197,94,.15) inset; }
    .title { font-weight:900; font-size:16px; }
    .muted { color:#666; font-size:12px; }

    .pill { display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; }
    .pill-long { border-color:#22c55e; }
    .pill-short { border-color:#ef4444; }

    .row { display:flex; justify-content:space-between; align-items:center; gap:8px; }

    .expandBtn{
      position:absolute;
      top:10px; right:10px;
      width:34px; height:34px;
      border-radius:10px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
    }

    .chartArea { margin-top:10px; flex:1; min-height:0; display:flex; flex-direction:column; gap:8px; }
    .priceChart { flex:1; min-height:0; border:1px solid #eee; border-radius:12px; overflow:hidden; }
    .macdChart { height:110px; border:1px solid #eee; border-radius:12px; overflow:hidden; }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(1300px, 98vw);
      height:min(820px, 96vh);
      background:#fff;
      border-radius:16px;
      overflow:hidden;
      display:flex; flex-direction:column;
      border:1px solid #ddd;
    }
    .modalHeader{
      padding:10px 12px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid #eee;
    }
    .modalClose{
      width:40px; height:36px;
      border-radius:12px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
      font-size:18px;
    }
    .modalBody{ padding:12px; flex:1; min-height:0; display:flex; flex-direction:column; gap:10px; }
    .modalCharts{ flex:1; min-height:0; display:flex; flex-direction:column; gap:10px; }
    .modalPrice{ flex:1; min-height:0; border:1px solid #eee; border-radius:14px; overflow:hidden; }
    .modalMacd{ height:160px; border:1px solid #eee; border-radius:14px; overflow:hidden; }
  </style>

  <!-- Lightweight Charts (v5) -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>

<body>
  <div class="top">
    <div>
      <div style="font-size:20px;font-weight:900;">FTMO – D1 EMA Çarşaf</div>
      <div class="muted">
        Mum + EMA20/50/100/200 (ince) + MACD histogram (koyu/açık) + LuxAlgo SR/Breaks. ⤢ ile tam ekran.
      </div>
    </div>
    <div>
      <div class="pager" id="pager"></div>
      <div class="muted" id="updated"></div>
    </div>
  </div>

  <div class="grid" id="grid">Yükleniyor...</div>

  <!-- Modal -->
  <div class="modalOverlay" id="modalOverlay" onclick="overlayClick(event)">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div>
          <div class="title" id="modalTitle">—</div>
          <div class="muted" id="modalSub">—</div>
        </div>
        <button class="modalClose" onclick="closeModal()">✕</button>
      </div>
      <div class="modalBody">
        <div class="muted" id="modalInfo"></div>
        <div class="modalCharts">
          <div class="modalPrice" id="modalPrice"></div>
          <div class="modalMacd" id="modalMacd"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const API_BASE = "https://ftmo-carsaf.onrender.com";

  const PAGES = [
    ["EURUSD","USDJPY","GBPUSD","AUDUSD"],
    ["USDCAD","USDCHF","EURJPY","EURGBP"],
    ["GBPJPY","AUDJPY","XAUUSD","XAGUSD"],
    ["USOIL","US500","NAS100","US30"],
    ["GER40","UK100","JP225","AUS200"],
  ];

  let currentPage = 0;

  function pill(item){
    if (item.sheet === "LONG") return `<span class="pill pill-long">ÇARŞAF LONG</span>`;
    if (item.sheet === "SHORT") return `<span class="pill pill-short">ÇARŞAF SHORT</span>`;
    return `<span class="pill">NONE</span>`;
  }
  function cardClass(item){
    if (item.sheet === "LONG" || item.sheet === "SHORT") return "card green";
    return "card";
  }
  function fmt(n){
    if (typeof n !== "number") return "-";
    return n.toFixed(2);
  }

  function renderPager(){
    const pager = document.getElementById("pager");
    pager.innerHTML = "";
    for (let i=0;i<PAGES.length;i++){
      const b = document.createElement("button");
      b.textContent = `Sayfa ${i+1}`;
      if (i===currentPage) b.classList.add("active");
      b.onclick = () => loadData(i);
      pager.appendChild(b);
    }
    const r = document.createElement("button");
    r.textContent = "Yenile";
    r.onclick = () => loadData(currentPage);
    pager.appendChild(r);
  }

  function createChartCommon(container){
    return LightweightCharts.createChart(container, {
      layout: { background: { type: 'solid', color: '#ffffff' }, textColor: '#222' },
      rightPriceScale: { borderVisible: false },
      timeScale: { borderVisible: false },
      grid: { vertLines: { visible: false }, horzLines: { visible: false } },
      crosshair: { mode: 1 },
    });
  }

  // MACD histogram: TradingView gibi koyu/açık kırmızı-yeşil
  function mapMacdColors(macdHistArr){
    if (!macdHistArr || macdHistArr.length === 0) return [];
    const GREEN_STRONG = "#089981";
    const GREEN_WEAK   = "#9fd9c9";
    const RED_STRONG   = "#f23645";
    const RED_WEAK     = "#f5a3ab";

    return macdHistArr.map((p, i, arr) => {
      const prev = i > 0 ? arr[i - 1].value : p.value;
      const strengthening = Math.abs(p.value) >= Math.abs(prev);

      let color;
      if (p.value >= 0) color = strengthening ? GREEN_STRONG : GREEN_WEAK;
      else color = strengthening ? RED_STRONG : RED_WEAK;

      return { time: p.time, value: p.value, color };
    });
  }

  function markerShape(m){
    // LightweightCharts marker shapes: 'circle', 'square', 'arrowUp', 'arrowDown'
    if (m.shape === "arrowUp") return "arrowUp";
    if (m.shape === "arrowDown") return "arrowDown";
    return "circle";
  }

  function markerPos(m){
    // position: 'aboveBar' | 'belowBar' | 'inBar'
    if (m.position === "aboveBar") return "aboveBar";
    if (m.position === "belowBar") return "belowBar";
    return "inBar";
  }

  function markerColor(m){
    return m.color === "green" ? "#16a34a" : "#dc2626";
  }

  function buildChart(priceDiv, macdDiv, item, compactTimeAxis){
    priceDiv.innerHTML = "";
    macdDiv.innerHTML = "";

    const priceChart = createChartCommon(priceDiv);

    const candleSeries = priceChart.addSeries(LightweightCharts.CandlestickSeries, {});
    candleSeries.setData(item.candles || []);

    const emaCommon = {
    lineWidth: 1,
    priceLineVisible: false,  // ✅ nokta nokta yatay çizgi kapalı
    lastValueVisible: false,  // ✅ sağdaki fiyat etiketi kapalı
};

    const ema20  = priceChart.addSeries(LightweightCharts.LineSeries, emaCommon);
    const ema50  = priceChart.addSeries(LightweightCharts.LineSeries, emaCommon);
    const ema100 = priceChart.addSeries(LightweightCharts.LineSeries, emaCommon);
    const ema200 = priceChart.addSeries(LightweightCharts.LineSeries, emaCommon);


    ema20.setData(item.ema_lines?.ema20 || []);
    ema50.setData(item.ema_lines?.ema50 || []);
    ema100.setData(item.ema_lines?.ema100 || []);
    ema200.setData(item.ema_lines?.ema200 || []);

    // LuxAlgo SR çizgileri (segment)
    // Kırmızı: resistance, Mavi: support
    const segs = item.sr?.segments || [];
    for (const s of segs){
      const isRes = s.kind === "resistance";
      const color = isRes ? "#FF0000" : "#233dee";
      const lw = 3;

      const segSeries = priceChart.addSeries(LightweightCharts.LineSeries, {
        lineWidth: lw,
        color: color,
        priceLineVisible: false,
        lastValueVisible: false,
      });

      segSeries.setData([
        { time: s.t1, value: s.price },
        { time: s.t2, value: s.price },
      ]);
    }

    // LuxAlgo Break markers
    const mk = (item.sr?.markers || []).map(m => ({
      time: m.time,
      position: markerPos(m),
      color: markerColor(m),
      shape: markerShape(m),
      text: m.text
    }));
    LightweightCharts.createSeriesMarkers(candleSeries, mk);

    priceChart.timeScale().fitContent();

    // MACD hist
    const macdChart = LightweightCharts.createChart(macdDiv, {
      layout: { background: { type: 'solid', color: '#ffffff' }, textColor: '#222' },
      rightPriceScale: { borderVisible: false },
      timeScale: { borderVisible: false, visible: !compactTimeAxis },
      grid: { vertLines: { visible: false }, horzLines: { visible: false } },
      crosshair: { mode: 0 },
    });

    const histSeries = macdChart.addSeries(LightweightCharts.HistogramSeries, {});
    histSeries.setData(mapMacdColors(item.macd_hist));

    macdChart.timeScale().fitContent();

    // Resize
    const ro = new ResizeObserver(() => {
      priceChart.applyOptions({ width: priceDiv.clientWidth, height: priceDiv.clientHeight });
      macdChart.applyOptions({ width: macdDiv.clientWidth, height: macdDiv.clientHeight });
    });
    ro.observe(priceDiv);
    ro.observe(macdDiv);
  }

  // Modal
  function openModal(item){
    document.getElementById("modalTitle").textContent = item.name;
    document.getElementById("modalSub").textContent = `${item.symbol} • ${item.type}`;
    const srInfo = item.sr ? `SR: L=${item.sr.leftBars}, R=${item.sr.rightBars}, VolThr=${item.sr.volumeThresh}` : "";
    document.getElementById("modalInfo").innerHTML = item.ok ? `
      ${pill(item)} | Close: <b>${fmt(item.last_close)}</b>
      | EMA20: ${fmt(item.ema20)} • EMA50: ${fmt(item.ema50)} • EMA100: ${fmt(item.ema100)} • EMA200: ${fmt(item.ema200)}
      ${srInfo ? " | " + srInfo : ""}
    ` : `<span style="color:#b91c1c;">Veri/Hata:</span> ${item.error || ""}`;

    const overlay = document.getElementById("modalOverlay");
    overlay.style.display = "flex";
    document.body.style.overflow = "hidden";

    buildChart(document.getElementById("modalPrice"), document.getElementById("modalMacd"), item, false);
  }
  function closeModal(){
    document.getElementById("modalOverlay").style.display = "none";
    document.getElementById("modalPrice").innerHTML = "";
    document.getElementById("modalMacd").innerHTML = "";
    document.body.style.overflow = "auto";
  }
  function overlayClick(e){
    if (e.target && e.target.id === "modalOverlay") closeModal();
  }
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
  });

  async function loadData(pageIndex){
    currentPage = pageIndex;
    renderPager();

    const grid = document.getElementById("grid");
    grid.textContent = "Yükleniyor...";

    try {
      const res = await fetch(`${API_BASE}/api/watchlist/${currentPage + 1}`);
      const data = await res.json();

      document.getElementById("updated").textContent =
        `Son güncelleme (UTC): ${data.updated_utc} | Sayfa: ${data.page}`;

      const items = data.items || [];

      grid.innerHTML = "";
      for (const item of items){
        const priceId = `price_${item.name}`;
        const macdId  = `macd_${item.name}`;

        grid.insertAdjacentHTML("beforeend", `
          <div class="${cardClass(item)}">
            <button class="expandBtn" title="Büyüt" aria-label="Büyüt" data-name="${item.name}">⤢</button>

            <div class="row">
              <div class="title">${item.name}</div>
              ${pill(item)}
            </div>
            <div class="muted">${item.symbol} • ${item.type}</div>

            ${item.ok ? `
              <div style="margin-top:8px">
                <div>Close: <b>${fmt(item.last_close)}</b></div>
                <div class="muted">EMA20: ${fmt(item.ema20)} | EMA50: ${fmt(item.ema50)}</div>
                <div class="muted">EMA100: ${fmt(item.ema100)} | EMA200: ${fmt(item.ema200)}</div>
              </div>
            ` : `
              <div style="margin-top:8px;color:#b91c1c">Veri/Hata</div>
              <div class="muted">${item.error || ""}</div>
            `}

            <div class="chartArea">
              <div class="priceChart" id="${priceId}"></div>
              <div class="macdChart" id="${macdId}"></div>
            </div>
          </div>
        `);

        if (item.ok){
          buildChart(document.getElementById(priceId), document.getElementById(macdId), item, true);
        }
      }

      // expand buttons
      const btns = Array.from(document.querySelectorAll(".expandBtn"));
      for (const btn of btns){
        const nm = btn.getAttribute("data-name");
        const found = items.find(x => x.name === nm);
        btn.onclick = () => openModal(found);
      }
    } catch (e) {
      grid.innerHTML = `<div style="color:#b91c1c">Hata: ${e}</div>`;
    }
  }

  renderPager();
  loadData(0);
</script>
</body>
</html>
