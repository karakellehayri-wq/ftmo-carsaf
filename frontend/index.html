<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FTMO Çarşaf Takip</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; }
    .top { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin-top: 14px; }
    .card { border:2px solid #ddd; border-radius:14px; padding:12px; background:#fff; }
    .green { border-color:#22c55e; box-shadow: 0 0 0 2px rgba(34,197,94,.15) inset; }
    .title { font-weight:800; font-size:16px; }
    .muted { color:#666; font-size:12px; }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; }
    .pill-long { border-color:#22c55e; }
    .pill-short { border-color:#ef4444; }
    button { padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .pager { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .active { font-weight:900; }

    .chartWrap { margin-top:10px; border:1px solid #eee; border-radius:12px; overflow:hidden; }
    iframe { display:block; width:100%; height:180px; border:0; }
    .row { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  </style>
</head>
<body>
  <div class="top">
    <div>
      <div style="font-size:20px;font-weight:900;">FTMO – D1 EMA Çarşaf</div>
      <div class="muted">EMA20/50/100/200 sıralıysa kart yeşil border olur. Kart içinde TradingView mum mini-chart var.</div>
    </div>

    <div>
      <div class="pager">
        <button id="p1" class="active" onclick="loadData(0)">Sayfa 1</button>
        <button id="p2" onclick="loadData(1)">Sayfa 2</button>
        <button id="p3" onclick="loadData(2)">Sayfa 3</button>
        <button onclick="loadData(currentPage)">Yenile</button>
      </div>
      <div class="muted" id="updated"></div>
    </div>
  </div>

  <div class="grid" id="grid">Yükleniyor...</div>

<script>
  // ✅ Backend URL
  let API_BASE = "https://ftmo-carsaf.onrender.com";

  // 3 sayfa (8 + 8 + 4)
  const PAGES = [
    ["EURUSD","USDJPY","GBPUSD","AUDUSD","USDCAD","USDCHF","EURJPY","EURGBP"],
    ["GBPJPY","AUDJPY","XAUUSD","XAGUSD","USOIL","US500","NAS100","US30"],
    ["GER40","UK100","JP225","AUS200"]
  ];

  let currentPage = 0;

  // TradingView sembol eşlemesi (mini chart için)
  // Çalışmayan olursa 1-2 taneyi sonradan düzeltiriz.
  const TV_SYMBOL = {
    "EURUSD": "FX:EURUSD",
    "USDJPY": "FX:USDJPY",
    "GBPUSD": "FX:GBPUSD",
    "AUDUSD": "FX:AUDUSD",
    "USDCAD": "FX:USDCAD",
    "USDCHF": "FX:USDCHF",
    "EURJPY": "FX:EURJPY",
    "EURGBP": "FX:EURGBP",
    "GBPJPY": "FX:GBPJPY",
    "AUDJPY": "FX:AUDJPY",

    "XAUUSD": "OANDA:XAUUSD",
    "XAGUSD": "OANDA:XAGUSD",

    // Oil/Indices: bazen broker’a göre değişir. Şimdilik en yaygın TVC kullanıyoruz.
    "USOIL": "TVC:USOIL",
    "US500": "TVC:SPX",
    "NAS100": "TVC:NDX",
    "US30": "TVC:DJI",
    "GER40": "TVC:DEU40",
    "UK100": "TVC:UKX",
    "JP225": "TVC:NI225",
    "AUS200": "TVC:AU200"
  };

  // Mini chart iframe URL üretici
  function tvEmbedUrl(name){
    const sym = TV_SYMBOL[name];
    if (!sym) return null;

    // interval=D (Daily), style=1 (candles), hide toolbar/ideas, minimal
    const params = new URLSearchParams({
      symbol: sym,
      interval: "D",
      style: "1",
      theme: "light",
      hide_top_toolbar: "1",
      hide_side_toolbar: "1",
      allow_symbol_change: "0",
      studies: "",
      withdateranges: "0",
      saveimage: "0",
      details: "0",
      hotlist: "0",
      calendar: "0",
      locale: "tr"
    });

    return `https://s.tradingview.com/widgetembed/?${params.toString()}`;
  }

  function tvChartLink(name){
    const sym = TV_SYMBOL[name];
    if (!sym) return null;
    return `https://www.tradingview.com/chart/?symbol=${encodeURIComponent(sym)}`;
  }

  function setActive(pageIndex){
    document.getElementById("p1").classList.toggle("active", pageIndex === 0);
    document.getElementById("p2").classList.toggle("active", pageIndex === 1);
    document.getElementById("p3").classList.toggle("active", pageIndex === 2);
  }

  function cardClass(item){
    if (item.sheet === "LONG") return "card green";
    if (item.sheet === "SHORT") return "card green"; // istersen short için kırmızı border da yaparız
    return "card";
  }

  function pill(item){
    if (item.sheet === "LONG") return `<span class="pill pill-long">ÇARŞAF LONG</span>`;
    if (item.sheet === "SHORT") return `<span class="pill pill-short">ÇARŞAF SHORT</span>`;
    return `<span class="pill">NONE</span>`;
  }

  function fmt(n){
    if (typeof n !== "number") return "-";
    return n.toFixed(2);
  }

  function chartHtml(name){
    const url = tvEmbedUrl(name);
    if (!url) return `<div class="muted">Mini chart yok (sembol eşleşmedi)</div>`;
    const link = tvChartLink(name);
    const linkHtml = link ? `<a class="muted" href="${link}" target="_blank" rel="noreferrer">TradingView’de aç</a>` : "";
    return `
      <div class="chartWrap">
        <iframe src="${url}" loading="lazy"></iframe>
      </div>
      <div style="margin-top:6px;">${linkHtml}</div>
    `;
  }

  async function loadData(pageIndex){
    currentPage = pageIndex;
    setActive(currentPage);

    const grid = document.getElementById("grid");
    grid.textContent = "Yükleniyor...";

    try {
      const res = await fetch(`${API_BASE}/api/watchlist/${currentPage + 1}`);
      const data = await res.json();

      document.getElementById("updated").textContent =
        `Son güncelleme (UTC): ${data.updated_utc} | Sayfa: ${data.page}`;

      const wanted = new Set(PAGES[currentPage]);
      const items = (data.items || []).filter(x => wanted.has(x.name));

      grid.innerHTML = "";
      for (const item of items){
        grid.insertAdjacentHTML("beforeend", `
          <div class="${cardClass(item)}">
            <div class="row">
              <div class="title">${item.name}</div>
              ${pill(item)}
            </div>
            <div class="muted">${item.symbol} • ${item.type}</div>

            ${item.ok ? `
              <div style="margin-top:8px;">
                <div>Close: <b>${fmt(item.last_close)}</b></div>
                <div class="muted">EMA20: ${fmt(item.ema20)} | EMA50: ${fmt(item.ema50)}</div>
                <div class="muted">EMA100: ${fmt(item.ema100)} | EMA200: ${fmt(item.ema200)}</div>
              </div>
            ` : `
              <div style="margin-top:8px;color:#b91c1c;">Veri/Hata</div>
              <div class="muted">${item.error || item.reason || ""}</div>
            `}

            ${chartHtml(item.name)}
          </div>
        `);
      }

      if (grid.innerHTML.trim() === "") {
        grid.textContent = "Bu sayfada gösterilecek veri yok (isimler eşleşmedi).";
      }
    } catch (e) {
      grid.innerHTML = `<div style="color:#b91c1c;">Hata: ${e}</div>`;
    }
  }

  loadData(0);
</script>
</body>
</html>
