<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FTMO – D1 Panel</title>

  <style>
    html, body { height: 100%; }
    body { font-family: Arial, sans-serif; margin: 18px; }

    .top { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; }
    .pager { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    button { padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .active { font-weight:900; }

    .grid {
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: 1fr;
      gap: 14px;
      margin-top: 14px;
      height: calc(100vh - 120px);
    }

    .card {
      border:2px solid #ddd;
      border-radius:14px;
      padding:12px;
      background:#fff;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      min-height:0;
      position:relative;
    }
    .green { border-color:#22c55e; box-shadow: 0 0 0 2px rgba(34,197,94,.15) inset; }

    .title { font-weight:900; font-size:16px; }
    .muted { color:#666; font-size:12px; }

    .pill { display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; }
    .pill-long { border-color:#22c55e; }
    .pill-short { border-color:#ef4444; }

    .row { display:flex; justify-content:space-between; align-items:center; gap:8px; }

    .expandBtn{
      position:absolute;
      top:10px; right:10px;
      width:34px; height:34px;
      border-radius:10px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
      z-index:2;
    }

    .chartArea { margin-top:10px; flex:1; min-height:0; display:flex; flex-direction:column; gap:8px; }
    .priceChart { flex:1; min-height:0; border:1px solid #eee; border-radius:12px; overflow:hidden; }
    .macdChart { height:110px; border:1px solid #eee; border-radius:12px; overflow:hidden; }
    .stochChart{ height:95px; border:1px solid #eee; border-radius:12px; overflow:hidden; }

    /* FULLSCREEN MODAL */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:stretch; justify-content:stretch;
      padding:0;
      z-index:9999;
    }
    .modal{
      width:100vw;
      height:100vh;
      background:#fff;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      border:none;
    }
    .modalHeader{
      padding:10px 12px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid #eee;
      background: #fff;
      z-index: 5;
    }
    .modalClose{
      width:40px; height:36px;
      border-radius:12px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
      font-size:18px;
    }
    .modalBody{ padding:12px; flex:1; min-height:0; display:flex; flex-direction:column; gap:10px; }
    .modalCharts{ flex:1; min-height:0; display:flex; flex-direction:column; gap:10px; }
    .modalPrice{ flex:1; min-height:0; border:1px solid #eee; border-radius:0; overflow:hidden; }
    .modalMacd{ height:22vh; min-height:170px; border:1px solid #eee; border-radius:0; overflow:hidden; }
    .modalStoch{ height:18vh; min-height:140px; border:1px solid #eee; border-radius:0; overflow:hidden; }
  </style>

  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>

<body>
  <div class="top">
    <div>
      <div style="font-size:20px;font-weight:900;">FTMO – D1 Panel</div>
      <div class="muted">Candles + EMA20/50/100/200 (width=1) + MACD histogram (TV licht/donker) + Stoch(5,3,3) + LuxAlgo SR. Sync 100% en geen zoom/drag.</div>
    </div>
    <div>
      <div class="pager" id="pager"></div>
      <div class="muted" id="updated"></div>
    </div>
  </div>

  <div class="grid" id="grid">Yükleniyor...</div>

  <div class="modalOverlay" id="modalOverlay" onclick="overlayClick(event)">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div>
          <div class="title" id="modalTitle">—</div>
          <div class="muted" id="modalSub">—</div>
        </div>
        <button class="modalClose" onclick="closeModal()">✕</button>
      </div>
      <div class="modalBody">
        <div class="muted" id="modalInfo"></div>
        <div class="modalCharts">
          <div class="modalPrice" id="modalPrice"></div>
          <div class="modalMacd" id="modalMacd"></div>
          <div class="modalStoch" id="modalStoch"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const API_BASE = "https://ftmo-carsaf.onrender.com";

  const PAGES = [
    ["EURUSD","USDJPY","GBPUSD","AUDUSD"],
    ["USDCAD","USDCHF","EURJPY","EURGBP"],
    ["GBPJPY","AUDJPY","XAUUSD","XAGUSD"],
    ["USOIL","US500","NAS100","US30"],
    ["GER40","UK100","JP225","AUS200"],
  ];
  let currentPage = 0;

  function pill(item){
    if (item.sheet === "LONG") return `<span class="pill pill-long">ÇARŞAF LONG</span>`;
    if (item.sheet === "SHORT") return `<span class="pill pill-short">ÇARŞAF SHORT</span>`;
    return `<span class="pill">NONE</span>`;
  }
  function cardClass(item){
    if (item.sheet === "LONG" || item.sheet === "SHORT") return "card green";
    return "card";
  }
  function fmt(n){
    if (typeof n !== "number") return "-";
    return n.toFixed(2);
  }

  function renderPager(){
    const pager = document.getElementById("pager");
    pager.innerHTML = "";
    for (let i=0;i<PAGES.length;i++){
      const b = document.createElement("button");
      b.textContent = `Sayfa ${i+1}`;
      if (i===currentPage) b.classList.add("active");
      b.onclick = () => loadData(i);
      pager.appendChild(b);
    }
    const r = document.createElement("button");
    r.textContent = "Yenile";
    r.onclick = () => loadData(currentPage);
    pager.appendChild(r);
  }

  // ====== Helpers (Math) ======
  function ema(values, period){
    const k = 2 / (period + 1);
    let out = [];
    let prev = null;
    for (let i=0;i<values.length;i++){
      const v = values[i];
      if (v == null) { out.push(null); continue; }
      if (prev == null) prev = v;
      else prev = v * k + prev * (1 - k);
      out.push(prev);
    }
    return out;
  }

  function sma(values, period){
    let out = new Array(values.length).fill(null);
    let sum = 0;
    for (let i=0;i<values.length;i++){
      const v = values[i];
      sum += v;
      if (i >= period) sum -= values[i-period];
      if (i >= period-1) out[i] = sum / period;
    }
    return out;
  }

  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

  // ====== MACD colors (TV like strong/weak) ======
  function macdHistColors(hist){
    const GREEN_STRONG = "#089981";
    const GREEN_WEAK   = "#9fd9c9";
    const RED_STRONG   = "#f23645";
    const RED_WEAK     = "#f5a3ab";
    return hist.map((p, i) => {
      const prev = i>0 ? hist[i-1].value : p.value;
      const strengthening = Math.abs(p.value) >= Math.abs(prev);
      const color = (p.value >= 0)
        ? (strengthening ? GREEN_STRONG : GREEN_WEAK)
        : (strengthening ? RED_STRONG : RED_WEAK);
      return { time: p.time, value: p.value, color };
    });
  }

  // ====== LuxAlgo SR computation (Pivot High/Low) ======
  function computePivots(candles, leftBars=15, rightBars=15){
    const n = candles.length;
    const pivH = new Array(n).fill(null);
    const pivL = new Array(n).fill(null);

    for (let i=leftBars; i<n-rightBars; i++){
      const hi = candles[i].high;
      const lo = candles[i].low;

      let isHigh = true;
      let isLow  = true;

      for (let j=i-leftBars; j<=i+rightBars; j++){
        if (candles[j].high > hi) isHigh = false;
        if (candles[j].low  < lo) isLow  = false;
        if (!isHigh && !isLow) break;
      }
      if (isHigh) pivH[i] = hi;
      if (isLow)  pivL[i] = lo;
    }
    return { pivH, pivL };
  }

  function buildSRSeries(candles, pivArr){
    // horizontal segments like Pine "plot(pivot, change(pivot)?na:pivot, offset=-(rightBars+1))"
    // Here we just create a step-ish line that holds last pivot value until next pivot.
    let out = [];
    let last = null;
    for (let i=0;i<candles.length;i++){
      if (pivArr[i] != null) last = pivArr[i];
      out.push({ time: candles[i].time, value: last });
    }
    return out;
  }

  function computeVolumeOsc(candles){
    // Pine: short=ema(volume,5), long=ema(volume,10), osc=100*(short-long)/long
    const vols = candles.map(c => (typeof c.volume === "number" ? c.volume : null));
    if (vols.some(v => v == null)) return null;
    const e5  = ema(vols, 5);
    const e10 = ema(vols, 10);
    const osc = e5.map((v,i) => {
      const l = e10[i];
      if (v==null || l==null || l===0) return null;
      return 100*(v-l)/l;
    });
    return osc;
  }

  function tryBuildMarkers(candles, pivH, pivL, volumeThresh=20){
    // We'll approximate Pine conditions if volume exists.
    const osc = computeVolumeOsc(candles);
    if (!osc) return []; // no volume => no break markers

    let markers = [];
    // We need "usePivot" (fixnan(pivot)[1]) kind of: use last known pivot level.
    let lastH = null, lastL = null;

    for (let i=0;i<candles.length;i++){
      if (pivH[i] != null) lastH = pivH[i];
      if (pivL[i] != null) lastL = pivL[i];

      if (lastH == null || lastL == null) continue;

      const c = candles[i];
      const o = c.open, h = c.high, l = c.low, cl = c.close;

      const osci = osc[i];
      if (osci == null || osci <= volumeThresh) continue;

      // crossunder(close,lowUsePivot)
      const prevClose = i>0 ? candles[i-1].close : cl;
      const crossUnder = (prevClose >= lastL && cl < lastL);
      const crossOver  = (prevClose <= lastH && cl > lastH);

      // Not(open-close < high-open) etc (from Pine)
      const bearBodyOk = !(o - cl < h - o);    // condition used on break under support
      const bullBodyOk = !(o - l > cl - o);    // condition used on break above resistance

      // wicks
      const bullWick = (o - l > cl - o);
      const bearWick = (o - cl < h - o);

      if (crossUnder && bearBodyOk){
        markers.push({
          time: c.time,
          position: 'aboveBar',
          color: '#f23645',
          shape: 'arrowDown',
          text: 'B'
        });
      }
      if (crossOver && bullBodyOk){
        markers.push({
          time: c.time,
          position: 'belowBar',
          color: '#089981',
          shape: 'arrowUp',
          text: 'B'
        });
      }
      if (crossOver && bullWick){
        markers.push({
          time: c.time,
          position: 'belowBar',
          color: '#089981',
          shape: 'circle',
          text: 'Bull Wick'
        });
      }
      if (crossUnder && bearWick){
        markers.push({
          time: c.time,
          position: 'aboveBar',
          color: '#f23645',
          shape: 'circle',
          text: 'Bear Wick'
        });
      }
    }
    return markers;
  }

  // ====== Stochastic (5,3,3) ======
  function computeStoch(candles, kLen=5, kSmooth=3, dSmooth=3){
    const n = candles.length;
    const rawK = new Array(n).fill(null);

    for (let i=0;i<n;i++){
      if (i < kLen-1) continue;
      let hh = -Infinity, ll = Infinity;
      for (let j=i-kLen+1; j<=i; j++){
        hh = Math.max(hh, candles[j].high);
        ll = Math.min(ll, candles[j].low);
      }
      const denom = (hh-ll);
      rawK[i] = denom === 0 ? 0 : 100 * ((candles[i].close - ll) / denom);
    }

    const kSm = sma(rawK.map(v => v ?? 0), kSmooth).map((v,i)=> rawK[i]==null ? null : v);
    const dSm = sma(kSm.map(v => v ?? 0), dSmooth).map((v,i)=> kSm[i]==null ? null : v);

    const K = kSm.map((v,i)=> v==null ? null : clamp(v,0,100));
    const D = dSm.map((v,i)=> v==null ? null : clamp(v,0,100));

    const outK = [];
    const outD = [];
    for (let i=0;i<n;i++){
      outK.push({ time: candles[i].time, value: K[i] });
      outD.push({ time: candles[i].time, value: D[i] });
    }
    return { outK, outD };
  }

  // ====== Locked charts + perfect sync ======
  function createLockedChart(container, { showTime=false, hideRightScale=false } = {}){
    return LightweightCharts.createChart(container, {
      layout: { background: { type: 'solid', color: '#ffffff' }, textColor: '#222' },
      rightPriceScale: { borderVisible: false, visible: !hideRightScale },
      timeScale: {
        borderVisible: false,
        visible: showTime,
        rightOffset: 0,
        barSpacing: 8,
        fixLeftEdge: true,
        fixRightEdge: true,
      },
      grid: { vertLines: { visible: false }, horzLines: { visible: false } },
      crosshair: { mode: 1 },

      // interaction OFF
      handleScroll: { mouseWheel: false, pressedMouseMove: false, horzTouchDrag: false, vertTouchDrag: false },
      handleScale:  { mouseWheel: false, pinch: false, axisPressedMouseMove: false },
      kineticScroll: { mouse: false, touch: false },
    });
  }

  function syncTimeScales(master, slaves){
    let lock = false;
    master.timeScale().subscribeVisibleTimeRangeChange((range) => {
      if (lock || !range) return;
      lock = true;
      for (const ch of slaves) ch.timeScale().setVisibleRange(range);
      lock = false;
    });
  }

  function buildCharts(priceDiv, macdDiv, stochDiv, item, showTime){
    priceDiv.innerHTML = "";
    macdDiv.innerHTML = "";
    stochDiv.innerHTML = "";

    const priceChart = createLockedChart(priceDiv, { showTime, hideRightScale: false });
    const macdChart  = createLockedChart(macdDiv,  { showTime, hideRightScale: true });
    const stochChart = createLockedChart(stochDiv, { showTime, hideRightScale: true });

    // ---- Price: candles + EMA ----
    const candleSeries = priceChart.addSeries(LightweightCharts.CandlestickSeries, {});
    candleSeries.setData(item.candles || []);

    const emaCommon = {
      lineWidth: 1,
      priceLineVisible: false,
      lastValueVisible: false,
    };
    const e20  = priceChart.addSeries(LightweightCharts.LineSeries, emaCommon);
    const e50  = priceChart.addSeries(LightweightCharts.LineSeries, emaCommon);
    const e100 = priceChart.addSeries(LightweightCharts.LineSeries, emaCommon);
    const e200 = priceChart.addSeries(LightweightCharts.LineSeries, emaCommon);

    e20.setData(item.ema_lines?.ema20 || []);
    e50.setData(item.ema_lines?.ema50 || []);
    e100.setData(item.ema_lines?.ema100 || []);
    e200.setData(item.ema_lines?.ema200 || []);

    // ---- LuxAlgo SR lines ----
    const { pivH, pivL } = computePivots(item.candles || [], 15, 15);
    const resSeries = priceChart.addSeries(LightweightCharts.LineSeries, {
      lineWidth: 2,
      priceLineVisible: false,
      lastValueVisible: false,
      color: "#ff0000",
    });
    const supSeries = priceChart.addSeries(LightweightCharts.LineSeries, {
      lineWidth: 2,
      priceLineVisible: false,
      lastValueVisible: false,
      color: "#233dee",
    });

    resSeries.setData(buildSRSeries(item.candles || [], pivH));
    supSeries.setData(buildSRSeries(item.candles || [], pivL));

    // markers (only if volume exists)
    const markers = tryBuildMarkers(item.candles || [], pivH, pivL, 20);
    if (typeof candleSeries.setMarkers === "function" && markers.length){
      candleSeries.setMarkers(markers);
    }

    // ---- MACD histogram ----
    const histSeries = macdChart.addSeries(LightweightCharts.HistogramSeries, {});
    histSeries.setData(macdHistColors(item.macd_hist || []));

    // ---- Stoch(5,3,3) ----
    const { outK, outD } = computeStoch(item.candles || [], 5, 3, 3);
    const kLine = stochChart.addSeries(LightweightCharts.LineSeries, {
      lineWidth: 1,
      priceLineVisible: false,
      lastValueVisible: false,
      color: "#2563eb", // K
    });
    const dLine = stochChart.addSeries(LightweightCharts.LineSeries, {
      lineWidth: 1,
      priceLineVisible: false,
      lastValueVisible: false,
      color: "#f59e0b", // D
    });
    kLine.setData(outK);
    dLine.setData(outD);

    // Fit all and then hard-sync ranges
    priceChart.timeScale().fitContent();
    const range = priceChart.timeScale().getVisibleRange();
    if (range){
      macdChart.timeScale().setVisibleRange(range);
      stochChart.timeScale().setVisibleRange(range);
    }

    // Keep perfectly aligned forever
    syncTimeScales(priceChart, [macdChart, stochChart]);

    // Resize observer
    const ro = new ResizeObserver(() => {
      priceChart.applyOptions({ width: priceDiv.clientWidth, height: priceDiv.clientHeight });
      macdChart.applyOptions({ width: macdDiv.clientWidth, height: macdDiv.clientHeight });
      stochChart.applyOptions({ width: stochDiv.clientWidth, height: stochDiv.clientHeight });

      const r2 = priceChart.timeScale().getVisibleRange();
      if (r2){
        macdChart.timeScale().setVisibleRange(r2);
        stochChart.timeScale().setVisibleRange(r2);
      }
    });
    ro.observe(priceDiv); ro.observe(macdDiv); ro.observe(stochDiv);

    return { priceChart, macdChart, stochChart };
  }

  // Modal
  function openModal(item){
    document.getElementById("modalTitle").textContent = item.name;
    document.getElementById("modalSub").textContent = `${item.symbol} • ${item.type}`;
    document.getElementById("modalInfo").innerHTML = item.ok ? `
      ${pill(item)} | Close: <b>${fmt(item.last_close)}</b>
      | EMA20: ${fmt(item.ema20)} • EMA50: ${fmt(item.ema50)} • EMA100: ${fmt(item.ema100)} • EMA200: ${fmt(item.ema200)}
    ` : `<span style="color:#b91c1c;">Veri/Hata:</span> ${item.error || ""}`;

    const overlay = document.getElementById("modalOverlay");
    overlay.style.display = "flex";
    document.body.style.overflow = "hidden";

    if (item.ok){
      buildCharts(
        document.getElementById("modalPrice"),
        document.getElementById("modalMacd"),
        document.getElementById("modalStoch"),
        item,
        true
      );
    } else {
      document.getElementById("modalPrice").innerHTML = "";
      document.getElementById("modalMacd").innerHTML = "";
      document.getElementById("modalStoch").innerHTML = "";
    }
  }
  function closeModal(){
    document.getElementById("modalOverlay").style.display = "none";
    document.getElementById("modalPrice").innerHTML = "";
    document.getElementById("modalMacd").innerHTML = "";
    document.getElementById("modalStoch").innerHTML = "";
    document.body.style.overflow = "auto";
  }
  function overlayClick(e){
    if (e.target && e.target.id === "modalOverlay") closeModal();
  }
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

  async function loadData(pageIndex){
    currentPage = pageIndex;
    renderPager();

    const grid = document.getElementById("grid");
    grid.textContent = "Yükleniyor...";

    try {
      const res = await fetch(`${API_BASE}/api/watchlist/${currentPage + 1}`);
      const data = await res.json();

      document.getElementById("updated").textContent =
        `Son güncelleme (UTC): ${data.updated_utc} | Sayfa: ${data.page}`;

      const items = data.items || [];
      grid.innerHTML = "";

      for (const item of items){
        const priceId = `price_${item.name}`;
        const macdId  = `macd_${item.name}`;
        const stId    = `stoch_${item.name}`;

        grid.insertAdjacentHTML("beforeend", `
          <div class="${cardClass(item)}">
            <button class="expandBtn" title="Büyüt" aria-label="Büyüt" data-name="${item.name}">⤢</button>

            <div class="row">
              <div class="title">${item.name}</div>
              ${pill(item)}
            </div>
            <div class="muted">${item.symbol} • ${item.type}</div>

            ${item.ok ? `
              <div style="margin-top:8px">
                <div>Close: <b>${fmt(item.last_close)}</b></div>
                <div class="muted">EMA20: ${fmt(item.ema20)} | EMA50: ${fmt(item.ema50)}</div>
                <div class="muted">EMA100: ${fmt(item.ema100)} | EMA200: ${fmt(item.ema200)}</div>
              </div>
            ` : `
              <div style="margin-top:8px;color:#b91c1c">Veri/Hata</div>
              <div class="muted">${item.error || ""}</div>
            `}

            <div class="chartArea">
              <div class="priceChart" id="${priceId}"></div>
              <div class="macdChart" id="${macdId}"></div>
              <div class="stochChart" id="${stId}"></div>
            </div>
          </div>
        `);

        if (item.ok){
          buildCharts(
            document.getElementById(priceId),
            document.getElementById(macdId),
            document.getElementById(stId),
            item,
            false
          );
        }
      }

      for (const btn of document.querySelectorAll(".expandBtn")){
        const nm = btn.getAttribute("data-name");
        const found = items.find(x => x.name === nm);
        btn.onclick = () => openModal(found);
      }

    } catch (e) {
      grid.innerHTML = `<div style="color:#b91c1c">Hata: ${e}</div>`;
    }
  }

  renderPager();
  loadData(0);
</script>
</body>
</html>
